

# Документация по работе приложения


## Возможности:
- Учетная запись пользователя
  - Удаление
  - Изменение имени, пароля, email
  - ~~Друзья?~~
- Взаимодействие с курсами
  - Поиск курса
  - Поступление на курс, при этом он добавляется в личный кабинет
  - Уход с курса
  - "Мои курсы"
    - Прогресс каждого курса
    - Домашнее задание
    - Работа над ошибками
    - Невозможность продолжать обучение пока не выполнил работу над ошибками
  - ~~Оценивание курса?~~

## Реализация
Весь сайт держится на одной  MySQL базе данных - **fizportal_courses**
База данных имеет 8 таблиц:
- **users** - список пользователей и их данные.
- **courses** - список курсов и их данные.
- **themes** - список тем(каждая тема связана с строкой из таблицы **courses** внешним ключом).
- **users_courses** - таблица, реализующая связь "многие ко многим". Сопоставляет пользователя и курс, на который он записан.
- **tasks** - список задач(каждая задача связана с строкой из таблицы **themes** внешним ключом).
- **users_homework** - таблица, реализующая связь "многие ко многим". Сопоставляет пользователя и задачу из его домашней работы.
- **friends** -  таблица, реализующая связь "многие ко многим". Сопоставляет пользователя и его друга.
- **users_mistakes** -  таблица, реализующая связь "многие ко многим". Сопоставляет пользователя и задачу из его работы над ошибками.


### Cхема базы данных
  
![Cхема базы данных](schema.png)

***
За обеспечения взаимодействия
**user->server->database**
Отвечает несколько классов:
- **Validator** - Проверяет данные на корректность.
- **User_session** - класс управления сессией пользователя и cookie.
- **User** - Класс для работы приложения с пользователем(его данными). Передает данные классу-валидатору **Validator**, хэширует пароль, создает сессию с помощью класса **User_session** и передает управление классу **Users_table**.
- **Users_table** - Оперирует объектом класса **User**. Вносит уже готовые данные в таблицу **users**.
***
За создание и редактирование курсов отвечают классы:
- **Course** - Создает объект курса для дальнейшей работы с ним.
- **Course_table** - Оперирует объектом класса **Course**. Сохраняет курс в таблице **courses**.
- **Theme** - Создает объект темы для дальнейшей работы с ней.
- **Themes_table** - Оперирует объектом класса **Theme**. Сохраняет тему в таблице **themes**.
- **Task** - Cоздает объект задачи дальнейшей работы с ней.
- **Tasks_table** - Оперирует объектом класса **Task**. Сохраняет задачу в таблице **tasks**.
***
Отображением страниц управляет Фреймворк [**Twig**](https://twig.symfony.com/) посредством написанного мною класса **Render**. Он использует шаблоны отображения , лежащие в папке **templates**
***
Классы имеющие префикс ***_table*** реализуют интерфейс **Table**.
В этих классах используется фреймворк [**ReadBeanPHP**](https://redbeanphp.com/index.php) для взаимодействия с MySQL.
***
За зависимости отвечает [**Composer**](https://getcomposer.org/)

Чтоб подтянуть зависимости выполнить:
`$ composer install`
## Работа c cookie
В таблице **users** есть специальное поле ***hash***, которое хранит значение хэша, присваиваемого пользователю при авторизации. При создании cookie, этот же хэш сохраняется на клиенте и в дальнейшем сверяется с хэшем из базы.

Хэш получается из случайной последовательности **6 символов** после **md5** шифрования
Пример хэша:
`e80b5017098950fc58aad83c8c14978e`

## Алгоритм авторизации
1. Пользователь вводит свои данные(name, password)
2. Создается объект класса **User**
3. Создается объект класса **Validator** и ему передается объект пользователя для проверки корректности данных и заполненности полей
4. Если **Validator** возвращает `status=>"OK"`, создается объект класса **Users_table** для работы с БД, и там происходит сверка введенных данных
5. Если **Users_table** вернул **id** пользователя(авторизация успешна), создается объект класса **User_session** для создания сессии и cookie
6. После всех этапов происходит редирект.

Регистрация происходит по тому же принципу.
Данные пользователя помещаются в таблицу **users**
Пароли дважды проходят **md5** шифрование

## Алгоритм создания курса
Действия с курсами(создание, редактирование, удаление) может производить пользователь с правами админа( `rights=admin`)
1. Админ указывает название, описание, сложность и цену курса
2. Создается объект класса **Course**
3. Создается объект класса **Validator** и этот объект передается ему для проверки корректности данных и заполненности полей
4. Если **Validator** возвращает `status=>"OK"`, создается объект класса **Courses_table** для работы с БД, и туда заносятся данные курса
5. Если **Courses_table** вернул **id** курса, курс создан.

На странице редактирования курса по тому же принципу можно добавить тему в таблицу **themes**
На странице редактирования темы по тому же принципу можно добавить задачу в таблицу **tasks**
### Про задачи
Для создания текста задач, в связи использованием специальных формул, используется редактор [ckeditor](https://ckeditor.com/), поддерживающий ***LATEX***

Он подключается в шаблоне главной страницы **main.html** таким образом:
`<script  src="https://cdn.ckeditor.com/ckeditor5/27.0.0/classic/ckeditor.js"></script>`

Чтоб HTML-теги с некими предопределенными id (тут #editor1 и #editor2) стали полями для ввода ***LATEX***
на этой же странице есть строки:
```
<script>
	ClassicEditor
		.create( document.querySelector( '#editor1' ) )
	ClassicEditor
		.create( document.querySelector( '#editor2' ) )
</script>
```

Для компилирования ***LATEX*** формул на этой же странице подключаются [mathjax](https://www.mathjax.org/)
```
<script src='/js/mathjax-config.js' defer></script>
<script src='/vendor/mathjax/mathjax/es5/tex-chtml.js' async></script>
```
***
К каждой задаче могут быть приложены видео или конспекты. Для этого есть отдельная папка **`/tasks_data/conspects/`**

Изображения для задач хранятся в папке **`/tasks_data/images_for_tasks/`**
